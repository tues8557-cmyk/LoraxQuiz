<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lorax Escape Room - Global Ranking</title>
    
    <script type="module">
        // 1. í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ëª…í™•í•˜ê²Œ import í•©ë‹ˆë‹¤.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            orderBy, 
            limit 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Firebase ì„¤ì • (ì‘ì„±í•˜ì‹  ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”)
        const firebaseConfig = {
            apiKey: "AIzaSyDZ840nxSnRHJRfRYA4jCUZWaofhmEb8-Q",
            authDomain: "loraxquiz.firebaseapp.com",
            projectId: "loraxquiz",
            storageBucket: "loraxquiz.firebasestorage.app",
            messagingSenderId: "447106004390",
            appId: "1:447106004390:web:963e9819ef81d642d84b67",
            measurementId: "G-6HH0GZQNE6"
        };

        // 3. ì•± ì´ˆê¸°í™” ë° DB ì—°ê²°
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 4. ì ìˆ˜ ì €ì¥ í•¨ìˆ˜ (windowì— ì—°ê²°í•˜ì—¬ í€´ì¦ˆ ì½”ë“œì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ í•¨)
        window.saveScore = async (name, time) => {
            try {
                // 'scores'ë¼ëŠ” ì´ë¦„ì˜ ì»¬ë ‰ì…˜(í´ë”)ì— ì €ì¥í•©ë‹ˆë‹¤.
                await addDoc(collection(db, "scores"), {
                    name: name,
                    time: parseInt(time), // ìˆ«ìë¡œ í™•ì‹¤íˆ ì €ì¥
                    date: new Date()
                });
                console.log("Score saved successfully!");
            } catch (e) { 
                console.error("Error saving score: ", e); 
                alert("ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };

        // 5. ìˆœìœ„ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        window.loadLeaderboard = async () => {
            try {
                // ì‹œê°„(time) ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ(ì‘ì€ ìˆ«ìê°€ ìœ„ë¡œ) ì •ë ¬í•˜ì—¬ 30ê°œ ê°€ì ¸ì˜´
                const q = query(collection(db, "scores"), orderBy("time", "asc"), limit(30));
                const querySnapshot = await getDocs(q);
                const bodies = document.querySelectorAll('.leaderboard-body');
                
                let tableHTML = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    tableHTML += `<tr><td>${rank++}</td><td>${data.name}</td><td>${data.time}s</td></tr>`;
                });

                bodies.forEach(body => {
                    body.innerHTML = tableHTML || "<tr><td colspan='3'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                });
            } catch (e) {
                console.error("Error loading leaderboard: ", e);
            }
        };
    </script>

    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f1f8e9; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
        #game-container { width: 90%; max-width: 500px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; }
        .rank-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; background: #fff; border: 2px solid #4caf50; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; transition: 0.3s; z-index: 5; }
        .rank-icon:hover { background: #e8f5e9; transform: scale(1.1); }
        h1 { color: #2e7d32; margin-top: 10px; font-size: 24px; }
        .header-info { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        input, select { padding: 12px; width: 100%; box-sizing: border-box; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 15px; border: none; border-radius: 10px; cursor: pointer; background: #4caf50; color: white; font-size: 16px; width: 100%; font-weight: bold; transition: 0.2s; }
        button:hover { background: #388e3c; }
        button:disabled { background: #ccc; }
        .question { font-size: 18px; margin: 20px 0; line-height: 1.5; min-height: 80px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #penalty-msg { color: #d32f2f; font-weight: bold; height: 24px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background: #f1f8e9; color: #2e7d32; }
        .hidden { display: none !important; }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; border-radius: 20px; padding: 20px; box-sizing: border-box; overflow-y: auto; z-index: 10; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="login-screen">
        <div class="rank-icon" onclick="showGlobalRank()">ğŸ†</div>
        <h1>ğŸŒ³ The Lorax Escape</h1>
        <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!</p>
        <input type="text" id="nickname-input" placeholder="Your Nickname">
        <div style="text-align:left; margin:10px 0;">
            <label><strong>ëª¨ë“œ ì„ íƒ (Mode):</strong></label>
            <select id="language-mode">
                <option value="EN">English Main (ì˜ì–´ ìœ„ì£¼)</option>
                <option value="KO">Korean Main (í•œêµ­ì–´ ìœ„ì£¼)</option>
            </select>
        </div>
        <button onclick="startGame()">ê²Œì„ ì‹œì‘ (Start Game)</button>
    </div>

    <div id="rank-modal" class="modal hidden">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ† Global Top 30</h3>
            <span style="cursor:pointer; font-weight:bold; color:red;" onclick="closeRank()">[ë‹«ê¸°]</span>
        </div>
        <table>
            <thead><tr><th>Rank</th><th>Name</th><th>Time</th></tr></thead>
            <tbody class="leaderboard-body"></tbody>
        </table>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="header-info">
            <span>ğŸ‘¤ <span id="display-name"></span></span>
            <span>â±ï¸ <span id="timer">0</span>s</span>
        </div>
        <div id="penalty-msg"></div>
        <div class="question" id="question-text"></div>
        <div class="options-grid" id="options-container"></div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>ğŸ‰ íƒˆì¶œ ì„±ê³µ!</h2>
        <p>ìµœì¢… ê¸°ë¡: <span id="final-time" style="color:red; font-weight:bold;"></span>ì´ˆ</p>
        <hr>
        <h3>ğŸ† ì‹¤ì‹œê°„ ì „ì²´ ìˆœìœ„</h3>
        <table>
            <thead><tr><th>ìˆœìœ„</th><th>ë‹‰ë„¤ì„</th><th>ì‹œê°„</th></tr></thead>
            <tbody class="leaderboard-body"></tbody>
        </table>
        <br>
        <button onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
</div>

<script>
    // ì§ˆë¬¸ ë°ì´í„° (ë™ì¼í•¨)
    const questions = [
        { qEn: "What is Ted's last name?", qKo: "í…Œë“œì˜ ì„±ì€ ë¬´ì—‡ì¸ê°€ìš”?", options: ["Wiggins", "O'Hare", "Once-ler", "Lorax"], answer: "Wiggins" },
        { qEn: "What is the slogan of O'Hare Air?", qKo: "ì˜¤í—¤ì–´ ê³µê¸° íšŒì‚¬ì˜ ìŠ¬ë¡œê±´ì€?", options: ["Fresh air in a can", "Trees for everyone", "Cheap and clean", "Nature is best"], answer: "Fresh air in a can" },
        { qEn: "What does the Once-ler wear on his hands?", qKo: "ì›ìŠ¬ëŸ¬ê°€ ì†ì— ë¼ê³  ìˆëŠ” ê²ƒì€?", options: ["Long green gloves", "Red mittens", "White rings", "Nothing"], answer: "Long green gloves" },
        { qEn: "What instrument does the Once-ler play?", qKo: "ì›ìŠ¬ëŸ¬ê°€ ì—°ì£¼í•˜ëŠ” ì•…ê¸°ëŠ”?", options: ["Guitar", "Piano", "Flute", "Drums"], answer: "Guitar" },
        { qEn: "What is the name of the small Bar-ba-loot?", qKo: "ì‘ì€ ë°”ë°”ë£¨íŠ¸ ê³°ì˜ ì´ë¦„ì€?", options: ["Pipsqueak", "Barnaby", "Ted", "Silas"], answer: "Pipsqueak" },
        { qEn: "What is the 'Super-Axe-Hacker'?", qKo: "ìŠˆí¼ ë„ë¼ í•´ì»¤ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", options: ["A machine to cut trees", "A computer virus", "A secret weapon", "A new car"], answer: "A machine to cut trees" },
        { qEn: "Why does Mr. O'Hare hate trees?", qKo: "ì˜¤í—¤ì–´ ì”¨ê°€ ë‚˜ë¬´ë¥¼ ì‹«ì–´í•˜ëŠ” ì´ìœ ëŠ”?", options: ["They make free air", "They are too tall", "They are scary", "They attract bears"], answer: "They make free air" },
        { qEn: "What does Ted use to break the ground?", qKo: "í…Œë“œê°€ ë„ì‹œ ë°”ë‹¥ì„ ë¶€ìˆ˜ê¸° ìœ„í•´ ì‚¬ìš©í•œ ê²ƒì€?", options: ["An earthmover", "A hammer", "A shovel", "A rock"], answer: "An earthmover" },
        { qEn: "What is the 'Lerkim'?", qKo: "ì›ìŠ¬ëŸ¬ê°€ ì‚¬ëŠ” ê±´ë¬¼ì˜ ì´ë¦„ì€?", options: ["The Once-ler's house", "The city hall", "A factory", "A tree house"], answer: "The Once-ler's house" },
        { qEn: "What does Audrey paint in her backyard?", qKo: "ì˜¤ë“œë¦¬ê°€ ë’·ë§ˆë‹¹ ë²½ì— ê·¸ë¦° ê²ƒì€?", options: ["Truffula trees", "The Lorax", "Ted's face", "The sun"], answer: "Truffula trees" },
        { qEn: "What did the Once-ler use to bait the Lorax?", qKo: "ì›ìŠ¬ëŸ¬ê°€ ë¡œë ‰ìŠ¤ë¥¼ ìœ ì¸í•  ë•Œ ì“´ ìŒì‹ì€?", options: ["Marshmallows", "Apples", "Honey", "Candy"], answer: "Marshmallows" },
        { qEn: "What color is the sky in Thneedville?", qKo: "ì²˜ìŒ ë³´ì—¬ì§€ëŠ” ìŠ¤ë‹ˆë“œë¹Œì˜ í•˜ëŠ˜ì€?", options: ["Artificial blue", "Clear grey", "Sunset orange", "Always black"], answer: "Artificial blue" },
        { qEn: "Who tells Ted where to find the Once-ler?", qKo: "ì›ìŠ¬ëŸ¬ì˜ ìœ„ì¹˜ë¥¼ ì•Œë ¤ì¤€ ì‚¬ëŒì€?", options: ["Grammy Norma", "His Mom", "Audrey", "O'Hare"], answer: "Grammy Norma" },
        { qEn: "What is a Thneed described as?", qKo: "ìŠ¤ë‹ˆë“œëŠ” ì–´ë–»ê²Œ ë¬˜ì‚¬ë˜ë‚˜ìš”?", options: ["A thing everyone needs", "A luxury item", "A soft blanket", "A winter hat"], answer: "A thing everyone needs" },
        { qEn: "How does Ted escape the city?", qKo: "í…Œë“œëŠ” ì–´ë–»ê²Œ ë„ì‹œë¥¼ íƒˆì¶œí•˜ë‚˜ìš”?", options: ["A secret tunnel", "A flying car", "A big jump", "Walking normally"], answer: "A secret tunnel" },
        { qEn: "What are the singing fish called?", qKo: "ë…¸ë˜í•˜ëŠ” ë¬¼ê³ ê¸°ì˜ ì´ë¦„ì€?", options: ["Humming-Fish", "Rock-Fish", "Jazz-Fish", "Water-Birds"], answer: "Humming-Fish" },
        { qEn: "What did the Lorax arrive in?", qKo: "ë¡œë ‰ìŠ¤ëŠ” ë¬´ì—‡ê³¼ í•¨ê»˜ ë‚˜íƒ€ë‚¬ë‚˜ìš”?", options: ["A thundercloud", "A golden box", "A giant seed", "A rainbow"], answer: "A thundercloud" },
        { qEn: "Where did the Lorax go at the end?", qKo: "ë¡œë ‰ìŠ¤ëŠ” ë§ˆì§€ë§‰ì— ì–´ë””ë¡œ ê°”ë‚˜ìš”?", options: ["Up into the sky", "Under the ground", "To another city", "In a bottle"], answer: "Up into the sky" },
        { qEn: "What does Ted plant in the town center?", qKo: "í…Œë“œê°€ ë§ˆì„ í•œë³µíŒì— ì‹¬ì€ ê²ƒì€?", options: ["The last seed", "A plastic flag", "A Thneed", "A sign"], answer: "The last seed" },
        { qEn: "What happens to O'Hare at the end?", qKo: "ë§ˆì§€ë§‰ì— ì˜¤í—¤ì–´ ì”¨ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", options: ["Kicked out of town", "Becomes king", "Plants a tree", "Disappears"], answer: "Kicked out of town" }
    ];

    let currentIdx = 0;
    let timerInterval;
    let seconds = 0;
    let nickname = "";
    let mode = "EN";

    function showGlobalRank() {
        document.getElementById('rank-modal').classList.remove('hidden');
        window.loadLeaderboard();
    }

    function closeRank() {
        document.getElementById('rank-modal').classList.add('hidden');
    }

    function startGame() {
        nickname = document.getElementById('nickname-input').value.trim();
        mode = document.getElementById('language-mode').value;
        if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");
        
        document.getElementById('display-name').innerText = nickname;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        
        timerInterval = setInterval(() => {
            seconds++;
            document.getElementById('timer').innerText = seconds;
        }, 1000);
        
        showQuestion();
    }

    function showQuestion() {
        if (currentIdx >= questions.length) return endGame();
        const q = questions[currentIdx];
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        if (mode === "EN") {
            document.getElementById('question-text').innerHTML = `<strong>${q.qEn}</strong><br><small style="color:gray;">${q.qKo}</small>`;
        } else {
            document.getElementById('question-text').innerHTML = `<strong>${q.qKo}</strong><br><small style="color:gray;">${q.qEn}</small>`;
        }
        
        const shuffled = [...q.options].sort(() => Math.random() - 0.5);
        shuffled.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt, q.answer);
            container.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct) {
        if (selected === correct) {
            currentIdx++;
            showQuestion();
        } else {
            const btns = document.querySelectorAll('#options-container button');
            btns.forEach(b => b.disabled = true);
            let timeLeft = 10;
            const msg = document.getElementById('penalty-msg');
            const pInterval = setInterval(() => {
                msg.innerText = `âŒ ì˜¤ë‹µ! ${timeLeft}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„ ê°€ëŠ¥`;
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(pInterval);
                    msg.innerText = "";
                    btns.forEach(b => b.disabled = false);
                }
            }, 1000);
        }
    }

    async function endGame() {
        clearInterval(timerInterval);
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-time').innerText = seconds;
        
        if (window.saveScore) {
            await window.saveScore(nickname, seconds);
            await window.loadLeaderboard();
        }
    }
</script>
</body>
</html>
